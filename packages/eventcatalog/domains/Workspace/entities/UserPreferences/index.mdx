---
id: UserPreferences
name: User Preferences
version: 0.0.1
summary: |
  Aggregate root managing persistent user-specific settings and UI state.
owners:
  - engineering
aggregateRoot: true
identifier: id
properties:
  - name: id
    type: string
    required: true
    format: uuid
    summary: Unique preferences identifier
  - name: userId
    type: reference
    required: true
    referenceTo: User
    summary: Reference to the user these preferences belong to
  - name: theme
    type: string
    required: true
    enum: [Light, Dark, System]
    summary: User's preferred color scheme
  - name: defaultCatalogId
    type: reference
    required: false
    referenceTo: Catalog
    summary: Optional default catalog selection for new sessions
  - name: uiStateJson
    type: string
    required: true
    summary: JSON blob encoding persistent UI state (panel sizes, collapsed sections, etc.)
---

## Overview

The UserPreferences aggregate persists user-specific settings that span sessions.
Preferences are initialized on first login and updated through explicit user actions.

## Decider Pattern

The UserPreferences aggregate follows the fmodel-rust Decider pattern.

**Commands handled:**
- `InitializePreferences`: Creates default preferences on first login
- `SetTheme`: Updates color scheme preference
- `SetDefaultCatalog`: Sets the default catalog for new sessions
- `ClearDefaultCatalog`: Removes default catalog selection
- `UpdateUiState`: Persists current UI layout state

**Events emitted:**
- `UserPreferencesInitialized`: Default preferences created
- `UserPreferencesThemeSet`: Theme updated
- `UserPreferencesDefaultCatalogSet`: Default catalog selected
- `UserPreferencesDefaultCleared`: Default catalog cleared
- `UserPreferencesUiStateUpdated`: UI state persisted

## Relationships

- **User** (Session): One-to-one relationship with User
- **Catalog** (Analytics): Optional reference to default catalog
- **UserPreferencesService**: Managed by UserPreferencesService

## Theme Integration

The theme preference integrates with Open Props' native theming:

| Value | Behavior |
|-------|----------|
| Light | Force light color scheme |
| Dark | Force dark color scheme |
| System | Follow OS preference via `prefers-color-scheme` |

## UI State Schema

The `uiStateJson` field persists transient UI state:

```json
{
  "sidebarCollapsed": false,
  "queryEditorHeight": 300,
  "resultPanelTab": "table",
  "recentCatalogs": ["uuid1", "uuid2"]
}
```

## Invariants

- Each user has exactly one UserPreferences aggregate
- UserPreferences is created lazily on first authenticated access
- Default catalog must reference an existing, accessible Catalog

## fmodel-rust Implementation

This aggregate implements the Decider pattern from fmodel-rust.

### decide

```rust
fn decide(cmd: PreferencesCommand, state: &PreferencesState) -> Result<Vec<PreferencesEvent>, String>
```

**Command handling logic:**

- **InitializePreferences** when `preferencesId` is `None`:
  - Validates: No preconditions
  - Produces: `PreferencesInitialized(preferences_id, timestamp)`
  - Error if already initialized: "Preferences already initialized"

- **SetTheme(theme)** when preferences exist:
  - Validates: Preferences must exist
  - Produces: `ThemeSet(theme, timestamp)`
  - Error if not initialized: "Preferences not initialized"

- **SetDefaultCatalog(catalog)** when preferences exist:
  - Validates: Preferences must exist
  - Produces: `DefaultCatalogSet(catalog, timestamp)`

- **ClearDefaultCatalog** when preferences exist:
  - Validates: Preferences must exist
  - Produces: `DefaultCatalogCleared(timestamp)`

- **UpdateUiState(json_blob)** when preferences exist:
  - Validates: Preferences must exist (JSON validation at boundary)
  - Produces: `UiStateUpdated(json_blob, timestamp)`

### evolve

```rust
fn evolve(state: PreferencesState, event: &PreferencesEvent) -> PreferencesState
```

**Event application logic:**

- **PreferencesInitialized(preferences_id, _)**:
  - Updates: `preferencesId` → `Some(preferences_id)`

- **ThemeSet(theme, _)**:
  - Updates: `theme` → provided value (Light, Dark, or System)

- **DefaultCatalogSet(catalog, _)**:
  - Updates: `defaultCatalog` → `Some(catalog)`

- **DefaultCatalogCleared(_)**:
  - Updates: `defaultCatalog` → `None`

- **UiStateUpdated(json_blob, _)**:
  - Updates: `uiState` → provided JSON string

### initial_state

```rust
fn initial_state() -> PreferencesState
```

Returns `PreferencesState` with:
- `preferencesId`: `None`
- `theme`: `Theme::System` (defer to OS preference)
- `defaultCatalog`: `None`
- `uiState`: `"{}"` (empty JSON object)

**Note:** One PreferencesState per authenticated user, enforced by aggregate ID construction (e.g., `AggregateId("UserPreferences", "user_123")`).
