---
id: UserPreferences
name: User Preferences
version: 0.0.1
summary: |
  Aggregate root managing persistent user-specific settings and UI state.
owners:
  - engineering
aggregateRoot: true
identifier: id
properties:
  - name: id
    type: string
    required: true
    format: uuid
    summary: Unique preferences identifier
  - name: userId
    type: reference
    required: true
    referenceTo: User
    summary: Reference to the user these preferences belong to
  - name: theme
    type: string
    required: true
    enum: [Light, Dark, System]
    summary: User's preferred color scheme
  - name: defaultCatalogId
    type: reference
    required: false
    referenceTo: Catalog
    summary: Optional default catalog selection for new sessions
  - name: uiStateJson
    type: string
    required: true
    summary: JSON blob encoding persistent UI state (panel sizes, collapsed sections, etc.)
---

## Overview

The UserPreferences aggregate persists user-specific settings that span sessions.
Preferences are initialized on first login and updated through explicit user actions.

## Decider Pattern

The UserPreferences aggregate follows the fmodel-rust Decider pattern.

**Commands handled:**
- `InitializePreferences`: Creates default preferences on first login
- `SetTheme`: Updates color scheme preference
- `SetDefaultCatalog`: Sets the default catalog for new sessions
- `ClearDefaultCatalog`: Removes default catalog selection
- `UpdateUiState`: Persists current UI layout state

**Events emitted:**
- `UserPreferencesInitialized`: Default preferences created
- `UserPreferencesThemeSet`: Theme updated
- `UserPreferencesDefaultCatalogSet`: Default catalog selected
- `UserPreferencesDefaultCleared`: Default catalog cleared
- `UserPreferencesUiStateUpdated`: UI state persisted

## Relationships

- **User** (Session): One-to-one relationship with User
- **Catalog** (Analytics): Optional reference to default catalog
- **UserPreferencesService**: Managed by UserPreferencesService

## Theme Integration

The theme preference integrates with Open Props' native theming:

| Value | Behavior |
|-------|----------|
| Light | Force light color scheme |
| Dark | Force dark color scheme |
| System | Follow OS preference via `prefers-color-scheme` |

## UI State Schema

The `uiStateJson` field persists transient UI state:

```json
{
  "sidebarCollapsed": false,
  "queryEditorHeight": 300,
  "resultPanelTab": "table",
  "recentCatalogs": ["uuid1", "uuid2"]
}
```

## Invariants

- Each user has exactly one UserPreferences aggregate
- UserPreferences is created lazily on first authenticated access
- Default catalog must reference an existing, accessible Catalog
