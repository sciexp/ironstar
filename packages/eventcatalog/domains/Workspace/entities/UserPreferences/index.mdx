---
id: UserPreferences
name: User Preferences
version: 0.0.1
summary: |
  Aggregate root managing user-scoped settings that follow the user across all workspaces.
owners:
  - engineering
aggregateRoot: true
identifier: id
properties:
  - name: id
    type: string
    required: true
    format: uuid
    summary: Unique preferences identifier
  - name: userId
    type: reference
    required: true
    referenceTo: User
    summary: Reference to the user these preferences belong to
  - name: theme
    type: string
    required: true
    enum: [Light, Dark, System]
    summary: User's preferred color scheme
  - name: locale
    type: string
    required: false
    summary: User's preferred locale for internationalization (e.g., en-US, de-DE)
  - name: uiStateJson
    type: string
    required: true
    summary: JSON blob encoding persistent UI state (panel sizes, collapsed sections, etc.)
---

## Overview

The UserPreferences aggregate persists user-scoped settings that follow the user across all workspaces.
These are global user settings independent of any particular workspace context.
Preferences are initialized on first login and updated through explicit user actions.

See WorkspacePreferences for workspace-scoped settings such as default catalog selection.

## Decider Pattern

The UserPreferences aggregate follows the fmodel-rust Decider pattern.

**Commands handled:**
- `InitializePreferences`: Creates default preferences on first login
- `SetTheme`: Updates color scheme preference
- `SetLocale`: Updates locale preference
- `UpdateUiState`: Persists current UI layout state

**Events emitted:**
- `UserPreferencesInitialized`: Default preferences created
- `UserPreferencesThemeSet`: Theme updated
- `UserPreferencesLocaleSet`: Locale updated
- `UserPreferencesUiStateUpdated`: UI state persisted

## Relationships

- **User** (Session): One-to-one relationship with User
- **UserPreferencesService**: Managed by UserPreferencesService
- **WorkspacePreferences**: See WorkspacePreferences for workspace-scoped settings

## Theme Integration

The theme preference integrates with Open Props' native theming:

| Value | Behavior |
|-------|----------|
| Light | Force light color scheme |
| Dark | Force dark color scheme |
| System | Follow OS preference via `prefers-color-scheme` |

## UI State Schema

The `uiStateJson` field persists transient UI state:

```json
{
  "sidebarCollapsed": false,
  "queryEditorHeight": 300,
  "resultPanelTab": "table",
  "recentCatalogs": ["uuid1", "uuid2"]
}
```

## Invariants

- Each user has exactly one UserPreferences aggregate
- UserPreferences is created lazily on first authenticated access
- Settings apply globally across all workspaces the user has access to

## fmodel-rust Implementation

This aggregate implements the Decider pattern from fmodel-rust.

### decide

```rust
fn decide(cmd: PreferencesCommand, state: &PreferencesState) -> Result<Vec<PreferencesEvent>, String>
```

**Command handling logic:**

- **InitializePreferences** when `preferencesId` is `None`:
  - Validates: No preconditions
  - Produces: `PreferencesInitialized(preferences_id, timestamp)`
  - Error if already initialized: "Preferences already initialized"

- **SetTheme(theme)** when preferences exist:
  - Validates: Preferences must exist
  - Produces: `ThemeSet(theme, timestamp)`
  - Error if not initialized: "Preferences not initialized"

- **SetLocale(locale)** when preferences exist:
  - Validates: Preferences must exist
  - Produces: `LocaleSet(locale, timestamp)`

- **UpdateUiState(json_blob)** when preferences exist:
  - Validates: Preferences must exist (JSON validation at boundary)
  - Produces: `UiStateUpdated(json_blob, timestamp)`

### evolve

```rust
fn evolve(state: PreferencesState, event: &PreferencesEvent) -> PreferencesState
```

**Event application logic:**

- **PreferencesInitialized(preferences_id, _)**:
  - Updates: `preferencesId` → `Some(preferences_id)`

- **ThemeSet(theme, _)**:
  - Updates: `theme` → provided value (Light, Dark, or System)

- **LocaleSet(locale, _)**:
  - Updates: `locale` → `Some(locale)`

- **UiStateUpdated(json_blob, _)**:
  - Updates: `uiState` → provided JSON string

### initial_state

```rust
fn initial_state() -> PreferencesState
```

Returns `PreferencesState` with:
- `preferencesId`: `None`
- `theme`: `Theme::System` (defer to OS preference)
- `locale`: `None` (defer to browser locale)
- `uiState`: `"{}"` (empty JSON object)

**Note:** One PreferencesState per authenticated user, enforced by aggregate ID construction (e.g., `AggregateId("UserPreferences", "user_123")`).
