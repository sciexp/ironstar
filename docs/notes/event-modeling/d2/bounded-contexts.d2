# Ironstar Bounded Contexts
# Strategic domain classification and integration patterns

direction: down

# Color conventions (Event Modeling standard)
# Aggregates: #f1c40f (yellow)
# Commands: #3498db (blue)
# Events: #e67e22 (orange)
# Read Models: #2ecc71 (green)
# External Systems: #9b59b6 (purple)

# Global edge styling: black lines, slightly thicker
style: {
  stroke: "#333"
  stroke-width: 3
}

# Classes for filled elements (transparent stroke)
classes: {
  aggregate: {
    style.fill: "#f1c40f"
    style.stroke: transparent
  }
  command: {
    style.fill: "#3498db"
    style.stroke: transparent
    style.font-color: "#fff"
  }
  event: {
    style.fill: "#e67e22"
    style.stroke: transparent
    style.font-color: "#fff"
  }
  readmodel: {
    style.fill: "#2ecc71"
    style.stroke: transparent
    style.font-color: "#fff"
  }
  sharedkernel: {
    style.fill: "#ffeaa7"
    style.stroke: transparent
  }
  external: {
    style.fill: "#9b59b6"
    style.stroke: transparent
    style.font-color: "#fff"
  }
}

# Strategic classification legend
legend: {
  label: "Strategic Classification"
  style.stroke: "#666"
  style.fill: "#fafafa"

  core: "Core" {
    style.fill: "#fff3cd"
    style.stroke: "#f1c40f"
    style.stroke-width: 3
  }
  supporting: "Supporting" {
    style.fill: "#e8f4fd"
    style.stroke: "#3498db"
    style.stroke-width: 2
  }
  generic: "Generic" {
    style.fill: "#f5f5f5"
    style.stroke: "#999"
    style.stroke-width: 1
    style.stroke-dash: 3
  }
}

# Session Context (Supporting - upstream identity provider)
# Note: OAuth flow (InitiateOAuth, ProcessOAuthCallback, etc.) is infrastructure
# handled by oauth2 crate at axum boundary. Session aggregate manages session
# lifecycle AFTER successful OAuth authentication. This is intentional.
session: "Session Context" {
  label: "Session Context\n[Supporting]"
  style.fill: "#e8f4fd"
  style.stroke: "#3498db"
  style.stroke-width: 2

  session_aggregate: "Session" {
    label: "Session\n(Aggregate)"
    class: aggregate
  }

  user_identity: "UserIdentity" {
    label: "UserIdentity\n(Value Object)\n[Shared Kernel]"
    class: sharedkernel
  }

  # OAuth is infrastructure boundary (purple = external system)
  # Session commands (CreateSession, RefreshSession, InvalidateSession)
  # are issued by boundary layer after OAuth callback completes
  oauth_callback: "OAuth Callback" {
    label: "OAuth Callback\n(Infrastructure)"
    class: external
  }

  # Events
  session_created: "SessionCreated" {
    class: event
  }
  session_expired: "SessionExpired" {
    class: event
  }

  oauth_callback -> session_aggregate: "authenticates"
  session_aggregate -> session_created
  session_aggregate -> session_expired
  session_aggregate -> user_identity: "contains"
}

# Todo Context (Generic Example - demonstration only)
todo: "Todo Context" {
  label: "Todo Context\n[Generic Example]"
  style.fill: "#f5f5f5"
  style.stroke: "#999"
  style.stroke-width: 1
  style.stroke-dash: 3

  todo_aggregate: "Todo" {
    label: "Todo\n(Aggregate)"
    class: aggregate
  }

  # Commands
  create_todo: "CreateTodo" {
    class: command
  }
  complete_todo: "CompleteTodo" {
    class: command
  }

  # Events
  todo_created: "TodoCreated" {
    class: event
  }
  todo_completed: "TodoCompleted" {
    class: event
  }

  # Read Models
  todo_list: "TodoList" {
    label: "TodoList\n(Read Model)"
    class: readmodel
  }

  create_todo -> todo_aggregate
  complete_todo -> todo_aggregate
  todo_aggregate -> todo_created
  todo_aggregate -> todo_completed
  todo_created -> todo_list: "projects to"
  todo_completed -> todo_list: "projects to"
}

# Analytics Context (Core - key differentiator)
analytics: "Analytics Context" {
  label: "Analytics Context\n[Core]"
  style.fill: "#fff3cd"
  style.stroke: "#f1c40f"
  style.stroke-width: 3

  query_session: "QuerySession" {
    label: "QuerySession\n(Aggregate)"
    class: aggregate
  }

  # Chart is Shared Kernel value objects (ChartType, ChartConfig, ChartData)
  # consumed by Workspace. Not an aggregate - no commands or events.
  chart: "Chart" {
    label: "Chart\n(Shared Kernel VO)"
    class: sharedkernel
  }

  catalog: "Catalog" {
    label: "Catalog\n(Aggregate)"
    class: aggregate
  }

  # Commands
  start_query: "StartQuery" {
    class: command
  }
  cancel_query: "CancelQuery" {
    class: command
  }
  select_catalog: "SelectCatalog" {
    class: command
  }
  refresh_catalog: "RefreshCatalogMetadata" {
    class: command
  }

  # Events
  query_started: "QueryStarted" {
    class: event
  }
  query_completed: "QueryCompleted" {
    class: event
  }
  query_failed: "QueryFailed" {
    class: event
  }
  catalog_selected: "CatalogSelected" {
    class: event
  }
  catalog_refreshed: "CatalogMetadataRefreshed" {
    class: event
  }

  # Read Models
  query_results: "QueryResults" {
    label: "QueryResults\n(Read Model)"
    class: readmodel
  }
  chart_data: "ChartData" {
    label: "ChartData\n(Read Model)"
    class: readmodel
  }

  start_query -> query_session
  cancel_query -> query_session
  query_session -> query_started
  query_session -> query_completed
  query_session -> query_failed
  query_completed -> query_results: "projects to"
  query_completed -> chart_data: "projects to"
  select_catalog -> catalog
  refresh_catalog -> catalog
  catalog -> catalog_selected
  catalog -> catalog_refreshed
}

# Workspace Context (Supporting - user personalization)
workspace: "Workspace Context" {
  label: "Workspace Context\n[Supporting]"
  style.fill: "#e8f4fd"
  style.stroke: "#3498db"
  style.stroke-width: 2

  dashboard_aggregate: "Dashboard" {
    label: "Dashboard\n(Aggregate)"
    class: aggregate
  }

  saved_query_aggregate: "SavedQuery" {
    label: "SavedQuery\n(Aggregate)"
    class: aggregate
  }

  user_preferences_aggregate: "UserPreferences" {
    label: "UserPreferences\n(Aggregate)"
    class: aggregate
  }

  # Commands (Dashboard)
  create_dashboard: "CreateDashboard" {
    class: command
  }
  add_chart: "AddChart" {
    class: command
  }
  remove_chart: "RemoveChart" {
    class: command
  }
  add_tab: "AddTab" {
    class: command
  }
  move_chart_to_tab: "MoveChartToTab" {
    class: command
  }

  # Commands (SavedQuery)
  save_query: "SaveQuery" {
    class: command
  }

  # Commands (Preferences)
  update_preferences: "UpdatePreferences" {
    class: command
  }

  # Events (Dashboard)
  dashboard_created: "DashboardCreated" {
    class: event
  }
  chart_added: "ChartAdded" {
    class: event
  }
  chart_removed: "ChartRemoved" {
    class: event
  }
  tab_added: "TabAdded" {
    class: event
  }
  chart_moved_to_tab: "ChartMovedToTab" {
    class: event
  }

  # Events (SavedQuery)
  query_saved: "QuerySaved" {
    class: event
  }

  # Events (Preferences)
  preferences_updated: "PreferencesUpdated" {
    class: event
  }

  # Read Models
  dashboard_view: "DashboardView" {
    label: "DashboardView\n(Read Model)"
    class: readmodel
  }

  # Command → Aggregate edges
  create_dashboard -> dashboard_aggregate
  add_chart -> dashboard_aggregate
  remove_chart -> dashboard_aggregate
  add_tab -> dashboard_aggregate
  move_chart_to_tab -> dashboard_aggregate
  save_query -> saved_query_aggregate
  update_preferences -> user_preferences_aggregate

  # Aggregate → Event edges
  dashboard_aggregate -> dashboard_created
  dashboard_aggregate -> chart_added
  dashboard_aggregate -> chart_removed
  dashboard_aggregate -> tab_added
  dashboard_aggregate -> chart_moved_to_tab
  saved_query_aggregate -> query_saved
  user_preferences_aggregate -> preferences_updated

  # Event → Read Model projections
  dashboard_created -> dashboard_view: "projects to"
  chart_added -> dashboard_view: "projects to"
  chart_removed -> dashboard_view: "projects to"
  tab_added -> dashboard_view: "projects to"
  chart_moved_to_tab -> dashboard_view: "projects to"
}

# Event Bus (Zenoh)
event_bus: "Event Bus (Zenoh)" {
  style.fill: "#ecf0f1"
  style.stroke: "#7f8c8d"
  style.stroke-width: 2
  style.border-radius: 8

  key_expressions: "Key Expressions" {
    label: |md
      events/session/{id}/**
      events/todo/{id}/**
      events/analytics/{id}/**
      events/workspace/{id}/**
    |
    style.fill: "#fff"
    style.font-size: 12
  }
}

# Integration patterns (edges between contexts)

# Session → Todo: Customer-Supplier (Session upstream)
session -> todo: "Customer-Supplier" {
  source-arrowhead: {
    shape: diamond
    style.filled: true
  }
  target-arrowhead: {
    shape: arrow
  }
}

# Session → Analytics: Customer-Supplier (Session upstream)
session -> analytics: "Customer-Supplier" {
  source-arrowhead: {
    shape: diamond
    style.filled: true
  }
  target-arrowhead: {
    shape: arrow
  }
}

# Session → Workspace: Shared Kernel (user identity flows)
session -> workspace: "Shared Kernel" {
  style.stroke-dash: 5
  source-arrowhead: {
    shape: arrow
  }
  target-arrowhead: {
    shape: arrow
  }
}

# Analytics → Workspace: Customer-Supplier (Workspace consumes ChartDefinitions)
analytics -> workspace: "Customer-Supplier" {
  source-arrowhead: {
    shape: diamond
    style.filled: true
  }
  target-arrowhead: {
    shape: arrow
  }
}

# All contexts publish to event bus
session -> event_bus: "publish" {
  style.stroke-dash: 3
}
todo -> event_bus: "publish" {
  style.stroke-dash: 3
}
analytics -> event_bus: "publish" {
  style.stroke-dash: 3
}
workspace -> event_bus: "publish" {
  style.stroke-dash: 3
}
